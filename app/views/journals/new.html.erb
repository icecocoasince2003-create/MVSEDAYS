<%= stylesheet_link_tag 'new', :media => "all" %>

<div class="new-journal-container">
  <div class="form-header">
    <h1 class="form-title">新しい日記を書く</h1>
    <p class="form-subtitle">あなたと博物館とのすばらしい出会いを記録しましょう</p>
  </div>

  <%= form_for @journal, url: {controller: 'journals', action: 'create'}, html: {class: 'journal-form'} do |f| %>

    <!-- 本文 -->
    <div class="form-group">
      <%= f.label :body, "本文", class: "form-label" %>
      <%= f.text_area :body, rows: 8, placeholder: "博物館での体験を綴りましょう...", class: "form-textarea" %>
    </div>

    <!-- カラム -->
    <div class="form-row">
      <!-- 訪問日 -->
      <div class="form-group form-group-half">
        <%= f.label :visit_date, "訪問日", class: "form-label" %>
        <%= f.date_field :visit_date, class: "form-input" %>
      </div>

      <!-- タグ -->
      <div class="form-group form-group-half">
        <%= f.label :tag_list, "タグ", class: "form-label" %>
        <%= f.text_field :tag_list, placeholder: "例: 国立博物館, 土器, 特別展", class: "form-input" %>
        <span class="form-hint">複数のタグはカンマ(,)で区切ってください</span>
      </div>
    </div>

    <!-- 画像アップロード -->
    <div class="form-group">
      <%= f.label :images, "写真（最大5枚）", class: "form-label" %>
      <div class="image-upload-container">
        <%= f.file_field :images, 
            class: "file-input", 
            accept: "image/*", 
            multiple: true,
            id: "journal_images",
            onchange: "previewImages(event)" %>
        <div class="file-upload-label" onclick="document.getElementById('journal_images').click()">
          <span class="upload-icon">📷</span>
          <span class="upload-text">クリックして写真を選択（複数可）</span>
          <span class="upload-hint">JPG, PNG, GIF対応 / 最大5枚</span>
        </div>
      </div>
      
      <!-- プレビューエリア -->
      <div id="image-preview-container" class="image-preview-grid">
        <!-- プレビュー画像がここに表示されます -->
      </div>
    </div>

    <!-- 評価 -->
    <div class="rating-section">
      <!-- 満足度 -->
      <div class="rating-group">
        <h5 class="rating-title">満足度</h5>
        <div class="post_form">
          <%= f.radio_button :overall, 5, id: 'star1' %>
          <label for="star1"><span class="text">5</span>★</label>

          <%= f.radio_button :overall, 4, id: 'star2' %>
          <label for="star2"><span class="text">4</span>★</label>

          <%= f.radio_button :overall, 3, id: 'star3' %>
          <label for="star3"><span class="text">3</span>★</label>

          <%= f.radio_button :overall, 2, id: 'star4' %>
          <label for="star4"><span class="text">2</span>★</label>

          <%= f.radio_button :overall, 1, id: 'star5' %>
          <label for="star5"><span class="text">1</span>★</label>
        </div>
      </div>

      <!-- おすすめ度 -->
      <div class="rating-group">
        <h5 class="rating-title">おすすめ度</h5>
        <div class="post_form">
          <%= f.radio_button :rate, 5, id: 'star6' %>
          <label for="star6"><span class="text">5</span>★</label>

          <%= f.radio_button :rate, 4, id: 'star7' %>
          <label for="star7"><span class="text">4</span>★</label>

          <%= f.radio_button :rate, 3, id: 'star8' %>
          <label for="star8"><span class="text">3</span>★</label>

          <%= f.radio_button :rate, 2, id: 'star9' %>
          <label for="star9"><span class="text">2</span>★</label>

          <%= f.radio_button :rate, 1, id: 'star10' %>
          <label for="star10"><span class="text">1</span>★</label>
        </div>
      </div>
    </div>

    <!-- 博物館選択 -->
    <div class="form-group">
      <%= f.label :museum_selection, "博物館", class: "form-label" %>

      <div class="museum-input-group">
        <!-- データベースから選択 -->
        <div class="museum-option">
          <label class="museum-option-label">
            <input type="radio" name="museum_input_type" value="database" checked>
            <span>データベースから選択</span>
          </label>

          <%= f.hidden_field :museum_id, id: 'journal_museum_id' %>

          <div class="museum-display-box" id="museum_display_box">
            <span class="museum-display-text" id="museum_display_text">博物館を選択してください</span>
          </div>

          <button type="button" class="museum-search-btn" id="open_museum_modal">
            🔍 博物館を検索
          </button>
        </div>

        <!-- 自由記述 -->
        <div class="museum-option">
          <label class="museum-option-label">
            <input type="radio" name="museum_input_type" value="custom">
            <span>その他の博物館（自由記述）</span>
          </label>

          <%= f.text_field :museum_name,
                           placeholder: "例: 地元の歴史資料館",
                           class: "form-input museum-custom-input",
                           id: "museum_custom_input",
                           disabled: true %>
        </div>
      </div>
    </div>

    <!-- 公開設定 -->
    <div class="form-group">
      <%= f.label :is_public, "公開設定", class: "form-label" %>
      <div class="radio-group">
        <label class="radio-label">
          <%= f.radio_button :is_public, true, checked: true %>
          <span class="radio-text">🌐 公開（みんなに見せる）</span>
        </label>
        <label class="radio-label">
          <%= f.radio_button :is_public, false %>
          <span class="radio-text">🔒 非公開（自分だけ）</span>
        </label>
      </div>
      <span class="form-hint">非公開の日記は自分だけが閲覧できます</span>
    </div>

    <!-- 送信ボタン -->
    <div class="form-actions">
      <%= link_to "キャンセル", journals_path, class: "btn btn-cancel" %>
      <%= f.submit "日記を記録する", class: "btn btn-submit" %>
    </div>

  <% end %>

</div>

<!-- 博物館検索モーダル -->
<div id="museum_modal" class="museum-modal">
  <div class="museum-modal-content">
    <div class="museum-modal-header">
      <h3>博物館を検索</h3>
      <button type="button" class="museum-modal-close" id="close_museum_modal">&times;</button>
    </div>

    <div class="museum-modal-body">
      <input type="text"
             id="museum_search_input"
             class="museum-search-input"
             placeholder="博物館名、都道府県、市区町村で検索...">

      <div id="museum_results" class="museum-results">
        <!-- JavaScriptで動的に生成 -->
      </div>
    </div>
  </div>
</div>

<script>
// 画像プレビュー機能
function previewImages(event) {
  const container = document.getElementById('image-preview-container');
  container.innerHTML = '';
  
  const files = event.target.files;
  
  if (files.length > 5) {
    alert('画像は最大5枚までアップロードできます');
    event.target.value = '';
    return;
  }
  
  if (files.length === 0) {
    return;
  }
  
  Array.from(files).forEach((file, index) => {
    if (!file.type.startsWith('image/')) {
      console.warn('画像ファイル以外はスキップ:', file.name);
      return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
      const previewDiv = document.createElement('div');
      previewDiv.className = 'image-preview-item';
      
      const img = document.createElement('img');
      img.src = e.target.result;
      img.alt = file.name;
      
      const fileName = document.createElement('p');
      fileName.className = 'image-preview-name';
      fileName.textContent = file.name;
      
      const fileSize = document.createElement('span');
      fileSize.className = 'image-preview-size';
      fileSize.textContent = formatFileSize(file.size);
      
      previewDiv.appendChild(img);
      previewDiv.appendChild(fileName);
      previewDiv.appendChild(fileSize);
      container.appendChild(previewDiv);
    };
    reader.readAsDataURL(file);
  });
}

// ファイルサイズをフォーマット
function formatFileSize(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
  return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

// 博物館入力タイプの切り替え
document.addEventListener('DOMContentLoaded', function() {
  const radioButtons = document.querySelectorAll('input[name="museum_input_type"]');
  const customInput = document.getElementById('museum_custom_input');
  const museumIdField = document.getElementById('journal_museum_id');
  const museumDisplayBox = document.getElementById('museum_display_box');
  const searchButton = document.getElementById('open_museum_modal');

  radioButtons.forEach(function(radio) {
    radio.addEventListener('change', function() {
      if (this.value === 'custom') {
        customInput.disabled = false;
        museumIdField.disabled = true;
        museumDisplayBox.style.opacity = '0.5';
        searchButton.disabled = true;
      } else {
        customInput.disabled = true;
        customInput.value = '';
        museumIdField.disabled = false;
        museumDisplayBox.style.opacity = '1';
        searchButton.disabled = false;
      }
    });
  });
});

(function() {
  'use strict';

  console.log('博物館選択スクリプト開始');

  window.museumsData = <%= raw Museum.all.map { |m|
    {
      id: m.id,
      name: m.name,
      prefecture: m.prefecture,
      city: m.city
    }
  }.to_json %>;

  console.log('博物館データ数:', window.museumsData.length);

  const modal = document.getElementById('museum_modal');
  const openBtn = document.getElementById('open_museum_modal');
  const closeBtn = document.getElementById('close_museum_modal');
  const searchInput = document.getElementById('museum_search_input');
  const resultsContainer = document.getElementById('museum_results');
  const displayBox = document.getElementById('museum_display_box');
  const displayText = document.getElementById('museum_display_text');
  const hiddenField = document.getElementById('journal_museum_id');

  if (!modal || !openBtn || !closeBtn || !searchInput || !resultsContainer) {
    console.error('必要なDOM要素が見つかりません');
    return;
  }

  openBtn.addEventListener('click', function(e) {
    e.preventDefault();
    e.stopPropagation();
    console.log('モーダルを開く');
    modal.style.display = 'flex';
    searchInput.value = '';
    renderMuseums(window.museumsData);
    searchInput.focus();
  });

  function closeModal() {
    console.log('モーダルを閉じる');
    modal.style.display = 'none';
  }

  closeBtn.addEventListener('click', function(e) {
    e.preventDefault();
    e.stopPropagation();
    closeModal();
  });

  modal.addEventListener('click', function(e) {
    if (e.target === modal) {
      closeModal();
    }
  });

  searchInput.addEventListener('input', function(e) {
    const query = e.target.value.toLowerCase().trim();
    console.log('検索クエリ:', query);

    if (query === '') {
      renderMuseums(window.museumsData);
    } else {
      const filtered = window.museumsData.filter(function(museum) {
        return museum.name.toLowerCase().includes(query) ||
               (museum.prefecture && museum.prefecture.toLowerCase().includes(query)) ||
               (museum.city && museum.city.toLowerCase().includes(query));
      });
      console.log('フィルター結果:', filtered.length);
      renderMuseums(filtered);
    }
  });

  function renderMuseums(museums) {
    resultsContainer.innerHTML = '';

    if (museums.length === 0) {
      resultsContainer.innerHTML = '<div class="museum-no-results">該当する博物館が見つかりません</div>';
      return;
    }

    museums.forEach(function(museum) {
      const item = document.createElement('div');
      item.className = 'museum-item';
      item.dataset.museumId = museum.id;

      const location = [museum.prefecture, museum.city].filter(Boolean).join(' ');

      item.innerHTML =
        '<div class="museum-item-name">' + escapeHtml(museum.name) + '</div>' +
        (location ? '<div class="museum-item-location">' + escapeHtml(location) + '</div>' : '');

      item.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        selectMuseum(museum);
      });

      resultsContainer.appendChild(item);
    });
  }

  function selectMuseum(museum) {
    console.log('博物館を選択:', museum);

    hiddenField.value = museum.id;

    const location = [museum.prefecture, museum.city].filter(Boolean).join(' ');
    displayText.innerHTML =
      '<strong>' + escapeHtml(museum.name) + '</strong>' +
      (location ? '<br><small>' + escapeHtml(location) + '</small>' : '');

    displayBox.classList.add('selected');

    closeModal();
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  renderMuseums(window.museumsData);

  console.log('博物館選択スクリプト初期化完了');
})();
</script>