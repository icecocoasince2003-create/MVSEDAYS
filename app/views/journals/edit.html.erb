<%= stylesheet_link_tag 'edit', :media => "all" %>

<div class="edit-journal-container">
  <!-- ヘッダー -->
  <div class="form-header">
    <h1 class="form-title">日記を編集</h1>
    <p class="form-subtitle">あなたと博物館の出会いの記録を更新しましょう</p>
  </div>

  <%= form_for @journal, html: {class: 'journal-form'} do |f| %>

    <!-- 本文 -->
    <div class="form-group">
      <%= f.label :body, "本文", class: "form-label" %>
      <%= f.text_area :body, rows: 8, placeholder: "博物館での体験を綴りましょう...", class: "form-textarea" %>
    </div>

    <!-- カラム -->
    <div class="form-row">
      <!-- 訪問日 -->
      <div class="form-group form-group-half">
        <%= f.label :visit_date, "訪問日", class: "form-label" %>
        <%= f.date_field :visit_date, class: "form-input" %>
      </div>

      <!-- タグ -->
      <div class="form-group form-group-half">
        <%= f.label :tag_list, "タグ", class: "form-label" %>
        <%= f.text_field :tag_list, placeholder: "例: 国立博物館, 土器, 特別展", class: "form-input" %>
        <span class="form-hint">複数のタグはカンマ(,)で区切ってください</span>
      </div>
    </div>

    <!-- 現在の画像表示 -->
    <% if @journal.images.attached? && @journal.images.any? %>
      <div class="form-group">
        <p class="form-label">現在の写真</p>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 0.5rem;">
          <% @journal.images.each do |image| %>
            <%= image_tag image, style: "width: 100%; height: 150px; object-fit: cover; border-radius: 4px; border: 2px solid #D4AF37;" %>
          <% end %>
        </div>
      </div>
    <% end %>

    <!-- 画像アップロード -->
    <div class="form-group">
      <%= f.label :images, @journal.images.attached? ? "新しい写真を追加" : "写真", class: "form-label" %>
      <%= f.file_field :images, 
          class: "form-control", 
          accept: "image/*", 
          multiple: true,
          id: "journal_images",
          onchange: "previewImages(event)" %>
      <div id="image-preview-container" style="display: none; margin-top: 1rem; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 0.5rem;"></div>
      <script>
      document.getElementById('journal_images').addEventListener('change', function(e) {
        var container = document.getElementById('image-preview-container');
        container.innerHTML = '';
        var files = e.target.files;
        if (files.length > 5) { alert('最大5枚まで'); e.target.value = ''; return; }
        if (files.length === 0) { container.style.display = 'none'; return; }
        container.style.display = 'grid';
        Array.from(files).forEach(function(file) {
          if (!file.type.startsWith('image/')) return;
          var reader = new FileReader();
          reader.onload = function(ev) {
            var img = document.createElement('img');
            img.src = ev.target.result;
            img.style.cssText = 'width: 100%; height: 100px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd;';
            container.appendChild(img);
          };
          reader.readAsDataURL(file);
        });
      });
      </script>
      <span class="form-hint">複数選択可（最大5枚）</span>
      
      <!-- プレビューエリア -->
      <div id="image-preview-container" style="display: none; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 0.5rem; margin-top: 1rem;">
        <!-- プレビュー画像がここに表示されます -->
      </div>
      
      <% if @journal.images.attached? %>
        <span class="form-hint">新しい写真を選択すると、現在の写真に追加されます</span>
      <% end %>
    </div>

    <!-- 評価 -->
    <div class="rating-section">
      <!-- 満足度 -->
      <div class="rating-group">
        <h5 class="rating-title">満足度</h5>
        <div class="post_form">
          <%= f.radio_button :overall, 5, id: 'star1' %>
          <label for="star1"><span class="text">5</span>★</label>

          <%= f.radio_button :overall, 4, id: 'star2' %>
          <label for="star2"><span class="text">4</span>★</label>

          <%= f.radio_button :overall, 3, id: 'star3' %>
          <label for="star3"><span class="text">3</span>★</label>

          <%= f.radio_button :overall, 2, id: 'star4' %>
          <label for="star4"><span class="text">2</span>★</label>

          <%= f.radio_button :overall, 1, id: 'star5' %>
          <label for="star5"><span class="text">1</span>★</label>
        </div>
      </div>

      <!-- おすすめ度 -->
      <div class="rating-group">
        <h5 class="rating-title">おすすめ度</h5>
        <div class="post_form">
          <%= f.radio_button :rate, 5, id: 'star6' %>
          <label for="star6"><span class="text">5</span>★</label>

          <%= f.radio_button :rate, 4, id: 'star7' %>
          <label for="star7"><span class="text">4</span>★</label>

          <%= f.radio_button :rate, 3, id: 'star8' %>
          <label for="star8"><span class="text">3</span>★</label>

          <%= f.radio_button :rate, 2, id: 'star9' %>
          <label for="star9"><span class="text">2</span>★</label>

          <%= f.radio_button :rate, 1, id: 'star10' %>
          <label for="star10"><span class="text">1</span>★</label>
        </div>
      </div>
    </div>

    <!-- 博物館選択 -->
    <div class="form-group">
      <%= f.label :museum_selection, "博物館", class: "form-label" %>

      <div class="museum-input-group">
        <!-- データベースから選択 -->
        <div class="museum-option">
          <label class="museum-option-label">
            <input type="radio" name="museum_input_type" value="database"
                   <%= 'checked' if @journal.museum_id.present? %>>
            <span>データベースから選択</span>
          </label>

          <%= f.select :museum_id,
                       options_for_select(
                         [["博物館を選択", ""]] +
                         Museum.all.map { |m| [m.name, m.id] },
                         @journal.museum_id
                       ),
                       {},
                       class: "form-select",
                       id: "museum_select" %>

          <%= link_to museums_path, class: "museum-search-btn", target: "_blank" do %>
            🔍 博物館を検索
          <% end %>

          <% if @journal.museum.present? %>
            <div class="selected-museum-info">
              <p class="museum-info-text">
                <span class="museum-info-label">選択中:</span>
                <span class="museum-info-name"><%= @journal.museum.name %></span>
              </p>
              <p class="museum-info-location">
                <%= @journal.museum.prefecture %> <%= @journal.museum.city %>
              </p>
            </div>
          <% end %>
        </div>

        <!-- 自由記述 -->
        <div class="museum-option">
          <label class="museum-option-label">
            <input type="radio" name="museum_input_type" value="custom"
                   <%= 'checked' if @journal.museum_name.present? && @journal.museum_id.blank? %>>
            <span>その他の博物館（自由記述）</span>
          </label>

          <%= f.text_field :museum_name,
                           placeholder: "例: 地元の歴史資料館",
                           class: "form-input museum-custom-input",
                           id: "museum_custom_input",
                           disabled: @journal.museum_id.present? || @journal.museum_name.blank? %>
        </div>
      </div>
    </div>

    <!-- 公開設定 -->
    <div class="form-group">
      <%= f.label :is_public, "公開設定", class: "form-label" %>
      <div class="radio-group">
        <label class="radio-label">
          <%= f.radio_button :is_public, true %>
          <span class="radio-text">🌐 公開（みんなに見せる）</span>
        </label>
        <label class="radio-label">
          <%= f.radio_button :is_public, false %>
          <span class="radio-text">🔒 非公開（自分だけ）</span>
        </label>
      </div>
      <span class="form-hint">非公開の日記は自分だけが閲覧できます</span>
    </div>

    <!-- 送信ボタン -->
    <div class="form-actions">
      <%= link_to "キャンセル", @journal, class: "btn btn-cancel" %>
      <%= f.submit "変更を保存", class: "btn btn-submit" %>
    </div>

  <% end %>
</div>

<script>
// 画像プレビュー機能（軽量版）
function previewImages(event) {
  const container = document.getElementById('image-preview-container');
  container.innerHTML = '';
  
  const files = event.target.files;
  
  if (files.length > 5) {
    alert('画像は最大5枚までアップロードできます');
    event.target.value = '';
    return;
  }
  
  if (files.length === 0) {
    container.style.display = 'none';
    return;
  }
  
  container.style.display = 'grid';
  
  Array.from(files).forEach((file) => {
    if (!file.type.startsWith('image/')) {
      return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
      const img = document.createElement('img');
      img.src = e.target.result;
      img.style.cssText = 'width: 100%; height: 100px; object-fit: cover; border-radius: 4px; border: 2px solid #D4AF37;';
      container.appendChild(img);
    };
    reader.readAsDataURL(file);
  });
}
</script>
  <script>
  // 画像プレビュー機能（統合版）
  document.addEventListener('DOMContentLoaded', function() {
    var input = document.getElementById('journal_images');
    var container = document.getElementById('image-preview-container');
    
    if (!input || !container) return;

    input.addEventListener('change', function(e) {
      container.innerHTML = '';
      var files = e.target.files;

      if (files.length > 5) {
        alert('画像は最大5枚までアップロードできます');
        e.target.value = '';
        container.style.display = 'none';
        return;
      }

      if (files.length === 0) {
        container.style.display = 'none';
        return;
      }

      container.style.display = 'grid';

      Array.from(files).forEach(function(file) {
        if (!file.type.startsWith('image/')) return;

        var reader = new FileReader();
        reader.onload = function(ev) {
          var img = document.createElement('img');
          img.src = ev.target.result;
          img.style.cssText = 'width: 100%; height: 100px; object-fit: cover; border-radius: 4px; border: 2px solid #c9a961;';
          container.appendChild(img);
        };
        reader.readAsDataURL(file);
      });
    });
  });
  </script>