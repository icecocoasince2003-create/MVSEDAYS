<%= stylesheet_link_tag 'edit', :media => "all" %>

<div class="edit-journal-container">
  <!-- ヘッダー -->
  <div class="form-header">
    <h1 class="form-title">日記を編集</h1>
    <p class="form-subtitle">あなたと博物館の出会いの記録を更新しましょう</p>
  </div>

  <%= form_for @journal, html: {class: 'journal-form'} do |f| %>
    
    <!-- 本文 -->
    <div class="form-group">
      <%= f.label :body, "本文", class: "form-label" %>
      <%= f.text_area :body, rows: 8, placeholder: "博物館での体験を綴りましょう...", class: "form-textarea" %>
    </div>

    <!-- カラム -->
    <div class="form-row">
      <!-- 訪問日 -->
      <div class="form-group form-group-half">
        <%= f.label :visit_date, "訪問日", class: "form-label" %>
        <%= f.date_field :visit_date, class: "form-input" %>
      </div>

      <!-- タグ -->
      <div class="form-group form-group-half">
        <%= f.label :tag_list, "タグ", class: "form-label" %>
        <%= f.text_field :tag_list, placeholder: "例: 国立博物館, 土器, 特別展", class: "form-input" %>
        <span class="form-hint">複数のタグはカンマ(,)で区切ってください</span>
      </div>
    </div>

        <!-- 現在の画像表示 -->
    <% if @journal.images.attached? && @journal.images.any? %>
      <div class="current-images-section">
        <p class="form-label">現在の写真</p>
        <div class="current-images-grid">
          <% @journal.images.each do |image| %>
            <div class="current-image-item">
              <%= image_tag image, class: "current-image" %>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <!-- 画像アップロード -->
    <div class="form-group">
      <%= f.label :images, @journal.images.attached? ? "新しい写真を追加（最大5枚）" : "写真（最大5枚）", class: "form-label" %>
      <div class="image-upload-container">
        <%= f.file_field :images, 
            class: "file-input", 
            accept: "image/*", 
            multiple: true,
            id: "journal_images",
            onchange: "previewImages(event)" %>
        <div class="file-upload-label" onclick="document.getElementById('journal_images').click()">
          <span class="upload-icon">📷</span>
          <span class="upload-text">クリックして写真を選択（複数可）</span>
          <span class="upload-hint">JPG, PNG, GIF対応 / 最大5枚</span>
        </div>
      </div>
      
      <!-- プレビューエリア -->
      <div id="image-preview-container" class="image-preview-grid">
        <!-- プレビュー画像がここに表示されます -->
      </div>
      
      <% if @journal.images.attached? %>
        <span class="form-hint">新しい写真を選択すると、現在の写真に追加されます</span>
      <% end %>
    </div>

    <!-- 評価 -->
    <div class="rating-section">
      <!-- 満足度 -->
      <div class="rating-group">
        <h5 class="rating-title">満足度</h5>
        <div class="post_form">
          <%= f.radio_button :overall, 5, id: 'star1' %>
          <label for="star1"><span class="text">5</span>★</label>
          
          <%= f.radio_button :overall, 4, id: 'star2' %>
          <label for="star2"><span class="text">4</span>★</label>
          
          <%= f.radio_button :overall, 3, id: 'star3' %>
          <label for="star3"><span class="text">3</span>★</label>
          
          <%= f.radio_button :overall, 2, id: 'star4' %>
          <label for="star4"><span class="text">2/span>★</label>
          
          <%= f.radio_button :overall, 1, id: 'star5' %>
          <label for="star5"><span class="text">1</span>★</label>
        </div>
      </div>

      <!-- おすすめ度 -->
      <div class="rating-group">
        <h5 class="rating-title">おすすめ度</h5>
        <div class="post_form">
          <%= f.radio_button :rate, 5, id: 'star6' %>
          <label for="star6"><span class="text">5</span>★</label>
          
          <%= f.radio_button :rate, 4, id: 'star7' %>
          <label for="star7"><span class="text">4</span>★</label>
          
          <%= f.radio_button :rate, 3, id: 'star8' %>
          <label for="star8"><span class="text">3</span>★</label>
          
          <%= f.radio_button :rate, 2, id: 'star9' %>
          <label for="star9"><span class="text">2</span>★</label>
          
          <%= f.radio_button :rate, 1, id: 'star10' %>
          <label for="star10"><span class="text">1</span>★</label>
        </div>
      </div>
    </div>

    <!-- 博物館選択 -->
    <div class="form-group">
      <%= f.label :museum_selection, "博物館", class: "form-label" %>
      
      <div class="museum-input-group">
        <!-- データベースから選択 -->
        <div class="museum-option">
          <label class="museum-option-label">
            <input type="radio" name="museum_input_type" value="database" 
                   <%= 'checked' if @journal.museum_id.present? %>>
            <span>データベースから選択</span>
          </label>
          
          <%= f.select :museum_id,
                       options_for_select(
                         [["博物館を選択", ""]] +
                         Museum.all.map { |m| [m.name, m.id] },
                         @journal.museum_id
                       ),
                       {},
                       class: "form-select",
                       id: "museum_select" %>
          
          <%= link_to museums_path, class: "museum-search-btn", target: "_blank" do %>
            🔍 博物館を検索
          <% end %>
          
          <% if @journal.museum.present? %>
            <div class="selected-museum-info">
              <p class="museum-info-text">
                <span class="museum-info-label">選択中:</span>
                <span class="museum-info-name"><%= @journal.museum.name %></span>
              </p>
              <p class="museum-info-location">
                <%= @journal.museum.prefecture %> <%= @journal.museum.city %>
              </p>
            </div>
          <% end %>
        </div>
        
        <!-- 自由記述 -->
        <div class="museum-option">
          <label class="museum-option-label">
            <input type="radio" name="museum_input_type" value="custom"
                   <%= 'checked' if @journal.museum_name.present? && @journal.museum_id.blank? %>>
            <span>その他の博物館（自由記述）</span>
          </label>
          
          <%= f.text_field :museum_name, 
                           placeholder: "例: 地元の歴史資料館", 
                           class: "form-input museum-custom-input",
                           id: "museum_custom_input",
                           disabled: @journal.museum_id.present? || @journal.museum_name.blank? %>
        </div>
      </div>
    </div>

    <!-- 公開設定 -->
    <div class="form-group">
      <%= f.label :is_public, "公開設定", class: "form-label" %>
      <div class="radio-group">
        <label class="radio-label">
          <%= f.radio_button :is_public, true %>
          <span class="radio-text">🌐 公開（みんなに見せる）</span>
        </label>
        <label class="radio-label">
          <%= f.radio_button :is_public, false %>
          <span class="radio-text">🔒 非公開（自分だけ）</span>
        </label>
      </div>
      <span class="form-hint">非公開の日記は自分だけが閲覧できます</span>
    </div>

    <!-- 送信ボタン -->
    <div class="form-actions">
      <%= link_to "キャンセル", @journal, class: "btn btn-cancel" %>
      <%= f.submit "変更を保存", class: "btn btn-submit" %>
    </div>

  <% end %>
</div>
<script>
// 画像プレビュー機能
function previewImages(event) {
  const container = document.getElementById('image-preview-container');
  container.innerHTML = '';
  
  const files = event.target.files;
  
  if (files.length > 5) {
    alert('画像は最大5枚までアップロードできます');
    event.target.value = '';
    return;
  }
  
  if (files.length === 0) {
    return;
  }
  
  Array.from(files).forEach((file, index) => {
    if (!file.type.startsWith('image/')) {
      console.warn('画像ファイル以外はスキップ:', file.name);
      return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
      const previewDiv = document.createElement('div');
      previewDiv.className = 'image-preview-item';
      
      const img = document.createElement('img');
      img.src = e.target.result;
      img.alt = file.name;
      
      const fileName = document.createElement('p');
      fileName.className = 'image-preview-name';
      fileName.textContent = file.name;
      
      const fileSize = document.createElement('span');
      fileSize.className = 'image-preview-size';
      fileSize.textContent = formatFileSize(file.size);
      
      previewDiv.appendChild(img);
      previewDiv.appendChild(fileName);
      previewDiv.appendChild(fileSize);
      container.appendChild(previewDiv);
    };
    reader.readAsDataURL(file);
  });
}

// ファイルサイズをフォーマット
function formatFileSize(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
  return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}
</script>