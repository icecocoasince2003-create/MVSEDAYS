<%= stylesheet_link_tag 'new', :media => "all" %>

<div class="new-journal-container">
  <div class="form-header">
    <h1 class="form-title">æ–°ã—ã„æ—¥è¨˜ã‚’æ›¸ã</h1>
    <p class="form-subtitle">ã‚ãªãŸã¨åšç‰©é¤¨ã¨ã®ã™ã°ã‚‰ã—ã„å‡ºä¼šã„ã‚’è¨˜éŒ²ã—ã¾ã—ã‚‡ã†</p>
  </div>

  <%= form_for @journal, url: {controller: 'journals', action: 'create'}, html: {class: 'journal-form'} do |f| %>
    
    <!-- æœ¬æ–‡ -->
    <div class="form-group">
      <%= f.label :body, "æœ¬æ–‡", class: "form-label" %>
      <%= f.text_area :body, rows: 8, placeholder: "åšç‰©é¤¨ã§ã®ä½“é¨“ã‚’ç¶´ã‚Šã¾ã—ã‚‡ã†...", class: "form-textarea" %>
    </div>

    <!-- ã‚«ãƒ©ãƒ  -->
    <div class="form-row">
      <!-- è¨ªå•æ—¥ -->
      <div class="form-group form-group-half">
        <%= f.label :visit_date, "è¨ªå•æ—¥", class: "form-label" %>
        <%= f.date_field :visit_date, class: "form-input" %>
      </div>

      <!-- ã‚¿ã‚° -->
      <div class="form-group form-group-half">
        <%= f.label :tag_list, "ã‚¿ã‚°", class: "form-label" %>
        <%= f.text_field :tag_list, placeholder: "ä¾‹: å›½ç«‹åšç‰©é¤¨, åœŸå™¨, ç‰¹åˆ¥å±•", class: "form-input" %>
        <span class="form-hint">è¤‡æ•°ã®ã‚¿ã‚°ã¯ã‚«ãƒ³ãƒ(,)ã§åŒºåˆ‡ã£ã¦ãã ã•ã„</span>
      </div>
    </div>

    <!-- ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ -->
    <div class="form-group">
      <%= f.label :images, "å†™çœŸ", class: "form-label" %>
      <div class="file-upload-area">
        <%= f.file_field :images, class: "file-input", accept: "image/*", multiple: true %>
        <div class="file-upload-label">
          <span class="upload-icon">ğŸ“·</span>
          <span class="upload-text">ã‚¯ãƒªãƒƒã‚¯ã—ã¦å†™çœŸã‚’é¸æŠ</span>
        </div>
      </div>
    </div>    

    <!-- è©•ä¾¡ -->
    <div class="rating-section">
      <!-- æº€è¶³åº¦ -->
      <div class="rating-group">
        <h5 class="rating-title">æº€è¶³åº¦</h5>
        <div class="post_form">
          <%= f.radio_button :overall, 5, id: 'star1' %>
          <label for="star1"><span class="text">5</span>â˜…</label>
          
          <%= f.radio_button :overall, 4, id: 'star2' %>
          <label for="star2"><span class="text">4</span>â˜…</label>
          
          <%= f.radio_button :overall, 3, id: 'star3' %>
          <label for="star3"><span class="text">3</span>â˜…</label>
          
          <%= f.radio_button :overall, 2, id: 'star4' %>
          <label for="star4"><span class="text">2</span>â˜…</label>
          
          <%= f.radio_button :overall, 1, id: 'star5' %>
          <label for="star5"><span class="text">1</span>â˜…</label>
        </div>
      </div>

      <!-- ãŠã™ã™ã‚åº¦ -->
      <div class="rating-group">
        <h5 class="rating-title">ãŠã™ã™ã‚åº¦</h5>
        <div class="post_form">
          <%= f.radio_button :rate, 5, id: 'star6' %>
          <label for="star6"><span class="text">5</span>â˜…</label>
          
          <%= f.radio_button :rate, 4, id: 'star7' %>
          <label for="star7"><span class="text">4</span>â˜…</label>
          
          <%= f.radio_button :rate, 3, id: 'star8' %>
          <label for="star8"><span class="text">3</span>â˜…</label>
          
          <%= f.radio_button :rate, 2, id: 'star9' %>
          <label for="star9"><span class="text">2</span>â˜…</label>
          
          <%= f.radio_button :rate, 1, id: 'star10' %>
          <label for="star10"><span class="text">1</span>â˜…</label>
        </div>
      </div>
    </div>

    <!-- åšç‰©é¤¨é¸æŠ -->
    <div class="form-group">
      <%= f.label :museum_id, "åšç‰©é¤¨", class: "form-label" %>
      
      <!-- Hidden field for museum_id -->
      <%= f.hidden_field :museum_id, id: 'journal_museum_id' %>
      
      <!-- åšç‰©é¤¨è¡¨ç¤ºãƒœãƒƒã‚¯ã‚¹ -->
      <div class="museum-display-box" id="museum_display_box">
        <span class="museum-display-text" id="museum_display_text">åšç‰©é¤¨ã‚’é¸æŠã—ã¦ãã ã•ã„</span>
      </div>
      
      <!-- æ¤œç´¢ãƒœã‚¿ãƒ³ -->
      <button type="button" class="museum-search-btn" id="open_museum_modal">
        ğŸ” åšç‰©é¤¨ã‚’æ¤œç´¢
      </button>
    </div>

    <!-- é€ä¿¡ãƒœã‚¿ãƒ³ -->
    <div class="form-actions">
      <%= link_to "ã‚­ãƒ£ãƒ³ã‚»ãƒ«", journals_path, class: "btn btn-cancel" %>
      <%= f.submit "æ—¥è¨˜ã‚’è¨˜éŒ²ã™ã‚‹", class: "btn btn-submit" %>
    </div>

  <% end %>
  
</div>

<!-- åšç‰©é¤¨æ¤œç´¢ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="museum_modal" class="museum-modal">
  <div class="museum-modal-content">
    <div class="museum-modal-header">
      <h3>åšç‰©é¤¨ã‚’æ¤œç´¢</h3>
      <button type="button" class="museum-modal-close" id="close_museum_modal">&times;</button>
    </div>
    
    <div class="museum-modal-body">
      <input type="text" 
             id="museum_search_input" 
             class="museum-search-input" 
             placeholder="åšç‰©é¤¨åã€éƒ½é“åºœçœŒã€å¸‚åŒºç”ºæ‘ã§æ¤œç´¢...">
      
      <div id="museum_results" class="museum-results">
        <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  'use strict';
  
  console.log('åšç‰©é¤¨é¸æŠã‚¹ã‚¯ãƒªãƒ—ãƒˆé–‹å§‹');
  
  // åšç‰©é¤¨ãƒ‡ãƒ¼ã‚¿ã‚’åŸ‹ã‚è¾¼ã¿
  window.museumsData = <%= raw Museum.all.map { |m| 
    { 
      id: m.id, 
      name: m.name, 
      prefecture: m.prefecture, 
      city: m.city 
    } 
  }.to_json %>;
  
  console.log('åšç‰©é¤¨ãƒ‡ãƒ¼ã‚¿æ•°:', window.museumsData.length);
  
  // DOMè¦ç´ ã®å–å¾—
  const modal = document.getElementById('museum_modal');
  const openBtn = document.getElementById('open_museum_modal');
  const closeBtn = document.getElementById('close_museum_modal');
  const searchInput = document.getElementById('museum_search_input');
  const resultsContainer = document.getElementById('museum_results');
  const displayBox = document.getElementById('museum_display_box');
  const displayText = document.getElementById('museum_display_text');
  const hiddenField = document.getElementById('journal_museum_id');
  
  // è¦ç´ ã®å­˜åœ¨ç¢ºèª
  if (!modal || !openBtn || !closeBtn || !searchInput || !resultsContainer) {
    console.error('å¿…è¦ãªDOMè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    return;
  }
  
  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
  openBtn.addEventListener('click', function(e) {
    e.preventDefault();
    e.stopPropagation();
    console.log('ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã');
    modal.style.display = 'flex';
    searchInput.value = '';
    renderMuseums(window.museumsData);
    searchInput.focus();
  });
  
  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
  function closeModal() {
    console.log('ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹');
    modal.style.display = 'none';
  }
  
  closeBtn.addEventListener('click', function(e) {
    e.preventDefault();
    e.stopPropagation();
    closeModal();
  });
  
  // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
  modal.addEventListener('click', function(e) {
    if (e.target === modal) {
      closeModal();
    }
  });
  
  // æ¤œç´¢æ©Ÿèƒ½
  searchInput.addEventListener('input', function(e) {
    const query = e.target.value.toLowerCase().trim();
    console.log('æ¤œç´¢ã‚¯ã‚¨ãƒª:', query);
    
    if (query === '') {
      renderMuseums(window.museumsData);
    } else {
      const filtered = window.museumsData.filter(function(museum) {
        return museum.name.toLowerCase().includes(query) ||
               (museum.prefecture && museum.prefecture.toLowerCase().includes(query)) ||
               (museum.city && museum.city.toLowerCase().includes(query));
      });
      console.log('ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼çµæœ:', filtered.length);
      renderMuseums(filtered);
    }
  });
  
  // åšç‰©é¤¨ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
  function renderMuseums(museums) {
    resultsContainer.innerHTML = '';
    
    if (museums.length === 0) {
      resultsContainer.innerHTML = '<div class="museum-no-results">è©²å½“ã™ã‚‹åšç‰©é¤¨ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>';
      return;
    }
    
    museums.forEach(function(museum) {
      const item = document.createElement('div');
      item.className = 'museum-item';
      item.dataset.museumId = museum.id;
      
      const location = [museum.prefecture, museum.city].filter(Boolean).join(' ');
      
      item.innerHTML = 
        '<div class="museum-item-name">' + escapeHtml(museum.name) + '</div>' +
        (location ? '<div class="museum-item-location">' + escapeHtml(location) + '</div>' : '');
      
      item.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        selectMuseum(museum);
      });
      
      resultsContainer.appendChild(item);
    });
  }
  
  // åšç‰©é¤¨ã‚’é¸æŠ
  function selectMuseum(museum) {
    console.log('åšç‰©é¤¨ã‚’é¸æŠ:', museum);
    
    // Hidden fieldã«å€¤ã‚’è¨­å®š
    hiddenField.value = museum.id;
    
    // è¡¨ç¤ºã‚’æ›´æ–°
    const location = [museum.prefecture, museum.city].filter(Boolean).join(' ');
    displayText.innerHTML = 
      '<strong>' + escapeHtml(museum.name) + '</strong>' +
      (location ? '<br><small>' + escapeHtml(location) + '</small>' : '');
    
    displayBox.classList.add('selected');
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    closeModal();
  }
  
  // HTML ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  
  // åˆæœŸè¡¨ç¤º
  renderMuseums(window.museumsData);
  
  console.log('åšç‰©é¤¨é¸æŠã‚¹ã‚¯ãƒªãƒ—ãƒˆåˆæœŸåŒ–å®Œäº†');
})();
</script>